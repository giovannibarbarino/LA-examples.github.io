<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editor Database JSON</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; }
    .obj { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; }
    input[type="text"] { width: 100%; margin: 5px 0; padding: 5px; }
    button { padding: 6px 10px; margin: 5px 4px 10px 0; }
    summary { cursor: pointer; }
  </style>
</head>
<body>

<details open style="margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 6px;">
  <summary style="font-weight: bold; font-size: 1.2em;">📘 Guida: Come proporre modifiche al database</summary>
  <ol>
    <li>🔍 <strong>Esamina gli oggetti presenti</strong>: Puoi modificare nome o tag direttamente nei campi sotto ogni oggetto.</li>
    <li>➕ <strong>Aggiungi nuovi oggetti</strong>: Usa la sezione "Aggiungi nuovo oggetto" per inserire un nome e uno o più tag separati da virgole.</li>
    <li>❌ <strong>Elimina un oggetto</strong>: Clicca su "Elimina" per rimuoverlo.</li>
    <li>💾 <strong>Le modifiche vengono salvate automaticamente</strong> nel browser.</li>
    <li>📤 <strong>Esporta la proposta</strong>: Scarica due file:
      <ul>
        <li><code>database-modificato.json</code>: Il nuovo database</li>
        <li><code>modifiche.txt</code>: Elenco dei cambiamenti</li>
      </ul>
    </li>
    <li>📧 <strong>Invia i file via email</strong>: Clicca su "<strong>📧 Invia via email</strong>" e allega i file.</li>
  </ol>
</details>

<h1>🔧 Proponi Modifiche al Database</h1>

<div id="listaOggetti"></div>

<h2>➕ Aggiungi nuovo oggetto</h2>
<div class="obj">
  <input type="text" id="nuovoNome" placeholder="Nome oggetto">
  <input type="text" id="nuoviTags" placeholder="Tag separati da virgola">
  <button onclick="aggiungiOggetto()">Aggiungi</button>
</div>

<hr>

<button onclick="esportaProposta()">📤 Esporta proposta di modifica</button>
<button onclick="inviaEmail()">📧 Invia via email</button>
<p><em>⚠️ Ricorda: le modifiche non vengono salvate automaticamente sul sito. Devono essere inviate manualmente.</em></p>

<script>
  let database = [];
  let originalDB = [];

  function caricaDatabase() {
    fetch("https://giovannibarbarino.github.io/LA-examples.github.io/data/database.json")
      .then(r => r.json())
      .then(data => {
        originalDB = JSON.parse(JSON.stringify(data));
        const local = localStorage.getItem("database");
        database = local ? JSON.parse(local) : data;
        renderListaOggetti();
      })
      .catch(() => {
        alert("Errore nel caricamento del database. Verrà usato un database vuoto.");
        database = [];
        originalDB = [];
        renderListaOggetti();
      });
  }

  function renderListaOggetti() {
    const container = document.getElementById("listaOggetti");
    if (database.length === 0) {
      container.innerHTML = "<p>Nessun oggetto presente.</p>";
      return;
    }
    container.innerHTML = database.map(obj => `
      <div class="obj">
        <input type="text" value="${obj.nome}" onchange="modificaNome(${obj.id}, this.value)">
        <input type="text" value="${obj.tags.join(', ')}" onchange="modificaTags(${obj.id}, this.value)">
        <button onclick="eliminaOggetto(${obj.id})">❌ Elimina</button>
      </div>
    `).join("");
  }

  function modificaNome(id, nuovoNome) {
    const index = database.findIndex(o => o.id === id);
    if (index !== -1) {
      database[index].nome = nuovoNome;
      salva();
    }
  }

  function modificaTags(id, tagString) {
    const index = database.findIndex(o => o.id === id);
    if (index !== -1) {
      database[index].tags = tagString.split(',').map(t => t.trim()).filter(t => t);
      salva();
    }
  }

  function eliminaOggetto(id) {
    if (!confirm("Sicuro di voler eliminare?")) return;
    database = database.filter(o => o.id !== id);
    salva();
    renderListaOggetti();
  }

  function aggiungiOggetto() {
    const nome = document.getElementById("nuovoNome").value.trim();
    const tags = document.getElementById("nuoviTags").value.split(",").map(t => t.trim()).filter(Boolean);
    if (!nome || tags.length === 0) return alert("Inserisci nome e almeno un tag.");
    const id = generaProssimoId();
    database.push({ id, nome, tags });
    salva();
    document.getElementById("nuovoNome").value = "";
    document.getElementById("nuoviTags").value = "";
    renderListaOggetti();
  }

  function generaProssimoId() {
    const idsEsistenti = database.map(obj => obj.id);
    let nuovoId = 1;
    while (idsEsistenti.includes(nuovoId)) {
      nuovoId++;
    }
    return nuovoId;
  }

  function salva() {
    localStorage.setItem("database", JSON.stringify(database));
  }

  function esportaProposta() {
    const jsonBlob = new Blob([JSON.stringify(database, null, 2)], { type: "application/json" });
    downloadFile(jsonBlob, "database-modificato.json");

    const modifiche = generaChangelog(originalDB, database);
    const txtBlob = new Blob([modifiche], { type: "text/plain" });
    downloadFile(txtBlob, "modifiche.txt");

    alert("File esportati! Ora puoi inviarli via email.");
  }

  function inviaEmail() {
    const subject = encodeURIComponent("Proposta modifica database JSON");
    const body = encodeURIComponent(`Ciao!\n\nIn allegato trovi:\n- database-modificato.json\n- modifiche.txt\n\nGrazie!`);
    const mailto = `mailto:giovanni.barbarino@gmail.com?subject=${subject}&body=${body}`;
    window.open(mailto, "_blank");
  }

  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  function generaChangelog(oldDb, newDb) {
    const log = [];

    const byId = arr => Object.fromEntries(arr.map(o => [o.id, o]));
    const oldMap = byId(oldDb);
    const newMap = byId(newDb);

    for (const id in newMap) {
      const nuovo = newMap[id];
      if (!oldMap[id]) {
        log.push(`➕ Aggiunto: "${nuovo.nome}" [${nuovo.tags.join(", ")}]`);
      } else {
        const vecchio = oldMap[id];
        if (nuovo.nome !== vecchio.nome) {
          log.push(`✏️ Modificato nome (ID ${id}): "${vecchio.nome}" → "${nuovo.nome}"`);
        }
        if (JSON.stringify(nuovo.tags) !== JSON.stringify(vecchio.tags)) {
          log.push(`✏️ Modificati tag (ID ${id}): [${vecchio.tags.join(", ")}] → [${nuovo.tags.join(", ")}]`);
        }
      }
    }

    for (const id in oldMap) {
      if (!newMap[id]) {
        log.push(`❌ Eliminato: "${oldMap[id].nome}"`);
      }
    }

    return log.join("\n");
  }

  caricaDatabase();
</script>

</body>
</html>
